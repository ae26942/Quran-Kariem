<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>بث القرآن الكريم - أحمد العجمي</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#27ae60">
    <meta name="description" content="بث القرآن الكريم بصوت أحمد العجمي مع تشغيل متتالي وعرض نصوص الآيات">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <!-- أنماط CSS -->
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            text-align: center;
            direction: rtl;
            padding: 20px;
            margin: 0;
        }
        h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 20px;
        }
        .player {
            background-color: #fff;
            padding: 20px;
            margin: 50px auto;
            width: 90%;
            max-width: 400px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        button {
            padding: 10px 20px;
            margin: 10px 5px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            background-color: #27ae60;
            color: white;
            border: none;
        }
        button:hover {
            background-color: #219653;
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        #installBtn {
            background-color: #3498db;
        }
        #installBtn:hover {
            background-color: #2980b9;
        }
        audio {
            display: none;
        }
        p {
            font-size: 18px;
            color: #34495e;
        }
        #status {
            margin-top: 10px;
            font-weight: bold;
        }
        #ayahsContainer {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        #ayahsContainer p {
            font-size: 16px;
            margin: 5px 0;
        }
        #toggleAyahsBtn {
            background-color: #e67e22;
        }
        #toggleAyahsBtn:hover {
            background-color: #d35400;
        }
    </style>
</head>
<body>
    <div class="player">
        <h1>بث القرآن الكريم</h1>
        <p>تلاوة بصوت القارئ أحمد بن علي العجمي</p>
        <p id="currentSurah">السورة الحالية: لم يبدأ التشغيل</p>
        <button id="playBtn" onclick="startPlayback()">تشغيل</button>
        <button id="stopBtn" onclick="stopPlayback()" disabled>إيقاف</button>
        <button id="prevBtn" onclick="playPreviousSurah()" disabled>السورة السابقة</button>
        <button id="nextBtn" onclick="playNextSurah()" disabled>السورة التالية</button>
        <button id="toggleAyahsBtn" onclick="toggleAyahs()" disabled>عرض/إخفاء الآيات</button>
        <button id="installBtn" onclick="installApp()">تثبيت التطبيق</button>
        <audio id="audioPlayer"></audio>
        <div id="status"></div>
        <div id="ayahsContainer"></div>
    </div>

    <script>
        const baseUrl = 'https://server6.mp3quran.net/ajm/';
        const surahNames = [
            '', 'الفاتحة', 'البقرة', 'آل عمران', 'النساء', 'المائدة', 'الأنعام', 'الأعراف', 'الأنفال', 'التوبة',
            'يونس', 'هود', 'يوسف', 'الرعد', 'إبراهيم', 'الحجر', 'النحل', 'الإسراء', 'الكهف', 'مريم',
            'طه', 'الأنبياء', 'الحج', 'المؤمنون', 'النور', 'الفرقان', 'الشعراء', 'النمل', 'القصص', 'العنكبوت',
            'الروم', 'لقمان', 'السجدة', 'الأحزاب', 'سبأ', 'فاطر', 'يس', 'الصافات', 'ص', 'الزمر',
            'غافر', 'فصلت', 'الشورى', 'الزخرف', 'الدخان', 'الجاثية', 'الأحقاف', 'محمد', 'الفتح', 'الحجرات',
            'ق', 'الذاريات', 'الطور', 'النجم', 'القمر', 'الرحمن', 'الواقعة', 'الحديد', 'المجادلة', 'الحشر',
            'الممتحنة', 'الصف', 'الجمعة', 'المنافقون', 'التغابن', 'الطلاق', 'التحريم', 'الملك', 'القلم', 'الحاقة',
            'المعارج', 'نوح', 'الجن', 'المزمل', 'المدثر', 'القيامة', 'الإنسان', 'المرسلات', 'النبأ', 'النازعات',
            'عبس', 'التكوير', 'الانفطار', 'المطففين', 'الانشقاق', 'البروج', 'الطارق', 'الأعلى', 'الغاشية', 'الفجر',
            'البلد', 'الشمس', 'الليل', 'الضحى', 'الشرح', 'التين', 'العلق', 'القدر', 'البينة', 'الزلزلة',
            'العاديات', 'القارعة', 'التكاثر', 'العصر', 'الهمزة', 'الفيل', 'قريش', 'الماعون', 'الكوثر', 'الكافرون',
            'النصر', 'المسد', 'الإخلاص', 'الفلق', 'الناس'
        ];
        const audioPlayer = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const toggleAyahsBtn = document.getElementById('toggleAyahsBtn');
        const currentSurahDisplay = document.getElementById('currentSurah');
        const statusDiv = document.getElementById('status');
        const ayahsContainer = document.getElementById('ayahsContainer');
        let currentSurahIndex = 1;
        let isPlaying = false;
        let ayahsVisible = false;

        // جلب نصوص الآيات من API القرآن
        async function fetchAyahs(surahNum) {
            try {
                const response = await fetch(`https://api.alquran.cloud/v1/surah/${surahNum}/ar`);
                const data = await response.json();
                return data.data.ayahs.map(ayah => ayah.text);
            } catch (error) {
                console.error('خطأ في جلب الآيات:', error);
                return ['تعذر جلب نصوص الآيات، تحقق من الاتصال بالإنترنت'];
            }
        }

        function getSurahUrl(surahNum) {
            let numStr = surahNum.toString().padStart(3, '0');
            return baseUrl + numStr + '.mp3';
        }

        async function playSurah(index) {
            if (index > 114) {
                index = 1; // إعادة التشغيل من الفاتحة
            } else if (index < 1) {
                index = 114; // العودة إلى الناس
            }
            const url = getSurahUrl(index);
            audioPlayer.src = url;
            try {
                await audioPlayer.play();
                currentSurahDisplay.textContent = `السورة الحالية: ${surahNames[index]}`;
                statusDiv.textContent = 'جاري التشغيل...';
                playBtn.disabled = true;
                stopBtn.disabled = false;
                prevBtn.disabled = false;
                nextBtn.disabled = false;
                toggleAyahsBtn.disabled = false;
                isPlaying = true;
                currentSurahIndex = index;

                if (ayahsVisible) {
                    const ayahs = await fetchAyahs(index);
                    ayahsContainer.innerHTML = '';
                    ayahs.forEach((ayah, i) => {
                        const p = document.createElement('p');
                        p.textContent = `(${i + 1}) ${ayah}`;
                        ayahsContainer.appendChild(p);
                    });
                    ayahsContainer.style.display = 'block';
                }
            } catch (error) {
                statusDiv.textContent = 'خطأ في تشغيل السورة: تأكد من الضغط على "تشغيل" أولاً أو تحقق من الإنترنت.';
                console.error('Audio play error:', error);
                playBtn.disabled = false;
                stopBtn.disabled = true;
                isPlaying = false;
            }
        }

        function playNextSurah() {
            playSurah(currentSurahIndex + 1);
        }

        function playPreviousSurah() {
            playSurah(currentSurahIndex - 1);
        }

        function startPlayback() {
            if (!isPlaying) {
                playSurah(currentSurahIndex);
            }
        }

        function stopPlayback() {
            audioPlayer.pause();
            audioPlayer.src = '';
            currentSurahDisplay.textContent = 'السورة الحالية: توقف التشغيل';
            statusDiv.textContent = 'تم الإيقاف';
            playBtn.disabled = false;
            stopBtn.disabled = true;
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            toggleAyahsBtn.disabled = true;
            ayahsContainer.style.display = 'none';
            isPlaying = false;
        }

        function toggleAyahs() {
            if (ayahsVisible) {
                ayahsContainer.style.display = 'none';
                toggleAyahsBtn.textContent = 'عرض الآيات';
                ayahsVisible = false;
            } else {
                ayahsContainer.style.display = 'block';
                toggleAyahsBtn.textContent = 'إخفاء الآيات';
                ayahsVisible = true;
                if (isPlaying) {
                    fetchAyahs(currentSurahIndex).then(ayahs => {
                        ayahsContainer.innerHTML = '';
                        ayahs.forEach((ayah, i) => {
                            const p = document.createElement('p');
                            p.textContent = `(${i + 1}) ${ayah}`;
                            ayahsContainer.appendChild(p);
                        });
                    });
                }
            }
        }

        audioPlayer.addEventListener('ended', playNextSurah);

        // PWA Installation Logic
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'inline-block';
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('تم تثبيت التطبيق');
                    }
                    deferredPrompt = null;
                });
            }
        }

        window.addEventListener('appinstalled', () => {
            console.log('تم تثبيت التطبيق على الجهاز');
            installBtn.style.display = 'none';
        });
    </script>
</body>
</html>
